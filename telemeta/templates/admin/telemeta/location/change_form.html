{% extends "admin/change_form.html" %}
{% load i18n admin_static admin_modify suit_tags admin_urls %}
{% load url from suit_compat %}
{% load leaflet_tags %}


{% block extrajs %}
    {{ block.super }}

    {% leaflet_js %}
    <script src="{{ STATIC_URL }}leaflet-control-geocoder/dist/Control.Geocoder.js" type="text/javascript"></script>

    <script>
        function map_init_basic (map, options) {

            // Type of geocoder to use
            geocoder = L.Control.Geocoder.nominatim({
                geocodingQueryParams:{limit:10,},
                });

            // Create a search control
            control = L.Control.geocoder({
                collapsed:false,
                placeholder:"Recherche ...",
                showResultIcons:true,
                geocoder: geocoder,

            })
            .on('markgeocode', function(e) {
                // When a geocoding is performed
                control._map.removeLayer(control._map.geocodeMarker);
                //  a marker with the new geocoded data is updated
                $("#id_latitude").val( e.geocode.center.lat );
                $("#id_longitude").val( e.geocode.center.lng );
                $("#id_name").val( e.geocode.properties.display_name );
            })
            .addTo(map);

            // There is some data ...
            if( $("#id_latitude").val()!=0 && $("#id_longitude").val()!=0 ) {
                // Create a marker with current data
                control._map.geocodeMarker = L.marker([$("#id_latitude").val(), $("#id_longitude").val()],{ draggable:true })
                .setPopupContent('<p>'+$("#id_name").val()+'</p>')
                .addTo(map)
                .openPopup();

                // Center the map on the current location
                map.setView([$("#id_latitude").val(), $("#id_longitude").val()],14);
            }
            else {
                // ... It's a new location
                // Zoom the map to the bounds
                bounds = L.bounds(
                    L.point( 50, -85 ),
                    L.point( 30, 0 )
                );
                map.setMaxZoom(18);
                map.setMaxBounds( bounds );
                map.fitBounds( [ [50, -85], [30, 0] ] );
            }

        }
    </script>
{% endblock %}


{% block extrastyle %}
    {{ block.super }}

    {% leaflet_css %}
    <style>
        .leaflet-container {  /* all maps */
            width:  100%;
            height: 600px;
        }

    </style>
    <link rel="stylesheet" href="{{ STATIC_URL }}leaflet-control-geocoder/dist/Control.Geocoder.css"/>
{% endblock %}


{% block field_sets %}
    {{ block.super }}
    <div class="control-group form-row field-localisation ">
        <div>
            <div class="control-label">
                <label class="" for="id_name">Localisation:</label>
            </div>
            <div class="controls">
                {% leaflet_map "mapItems" callback="window.map_init_basic" %}
            </div>
        </div>


    </div>
{% endblock %}
